<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯—è¯æ•°æ®åº“</title>
    <link rel="stylesheet" href="../css/è¯—è¯æ•°æ®åº“.css">
</head>

<body>
    <!-- æ–°å¢å¯¼èˆªæ  -->
    <nav class="main-nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="./ä¸»é¡µé¢.html" class="nav-link">
                    <span class="link-text">é¦–é¡µ</span>
                    <div class="link-border"></div>
                </a>
            </li>
            <li class="nav-item">
                <a href="./å”å®‹ç ”ç©¶.html" class="nav-link">
                    <span class="link-text">é«˜é¢‘è¯æ·±åº¦åˆ†æ</span>
                    <div class="link-border"></div>
                </a>
            </li>
            <li class="nav-item">
                <a href="./è¯—äººç¤¾ä¼šç½‘ç»œ.html" class="nav-link">
                    <span class="link-text">è¯—äººç¤¾ä¼šç½‘ç»œ</span>
                    <div class="link-border"></div>
                </a>
            </li>
            <li class="nav-item">
                <a href="./è¯—è·¯æ¢æº.html" class="nav-link">
                    <span class="link-text">è¯—è·¯æ¢æº</span>
                    <div class="link-border"></div>
                </a>
            </li>
        </ul>
    </nav>
    <div class="container">
        <div class="box">
            <div class="top">
                <div class="title-box">
                    <p class="title">è¯—è¯æ•°æ®åº“</p>
                </div>
                <div class="text-box">
                    <p class="text">
                        å”è¯—å®‹è¯ä½œä¸ºä¸­åæ–‡åŒ–ç‘°å®ï¼Œæ‰¿è½½ç€åƒå¹´æ–‡è„‰ä¸å®¡ç¾æ„è¶£ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿç ”ç©¶å¤šèšç„¦äºå•ç¯‡è¯—è¯çš„æ–‡æœ¬è§£è¯»æˆ–ä¸ªä½“ä½œè€…çš„åˆ›ä½œé£æ ¼ï¼Œç¼ºä¹å¯¹æµ·é‡è¯—è¯æ•°æ®çš„ç³»ç»Ÿæ€§å…³è”åˆ†æã€‚åœ¨æ•°æ®é©±åŠ¨çš„æ—¶ä»£ï¼Œé€šè¿‡æ„å»ºå¤šç»´åº¦ã€å¯äº¤äº’çš„è¯—è¯æ•°æ®åº“ï¼Œèƒ½å¤Ÿçªç ´ä¼ ç»Ÿç ”ç©¶èŒƒå¼ï¼Œä»¥é‡åŒ–è§†è§’æ­ç¤ºè¯—è¯é—´çš„éšæ€§å…³è”ã€å†å²æ¼”å˜è§„å¾‹åŠæ–‡åŒ–åŸºå› å¯†ç ã€‚æœ¬æ•°æ®åº“æ—¨åœ¨æ­å»ºä¸€åº§"æ•°å­—äººæ–‡"æ¡¥æ¢ï¼Œå°†å¤å…¸è¯—è¯çš„æ„Ÿæ€§ä¹‹ç¾ä¸æ•°æ®æŠ€æœ¯çš„ç†æ€§ä¹‹æ€ç›¸èåˆï¼Œä¸ºæ–‡å­¦ã€å†å²ã€ç¤¾ä¼šå­¦ç­‰é¢†åŸŸæä¾›æ–°å‹ç ”ç©¶å·¥å…·ã€‚
                    </p>
                    <p class="text">
                        æ•°æ®åº“çš„æ ¸å¿ƒä»·å€¼é¦–å…ˆç ´è§£"å…³è”è¿·é›¾"ï¼šé€šè¿‡æ•°æ®æ ‡ç­¾åŒ–ä¸ç®—æ³•å»ºæ¨¡ï¼Œæ­ç¤ºè¯—è¯é—´çš„ä¸»é¢˜äº’æ–‡ã€æ„è±¡æµåŠ¨ã€æƒ…æ„Ÿå…±é¸£ï¼ˆå¦‚"æœˆäº®"æ„è±¡åœ¨å”è¯—ä¸­çš„è¾¹å¡æ€ä¹¡ä¸å®‹è¯ä¸­çš„å©‰çº¦æŠ’æƒ…å·®å¼‚ï¼‰ï¼Œ
                        å…¶æ¬¡æ˜¯è¿˜åŸå†å²è¯­å¢ƒï¼šç»“åˆåœ°ç†ã€æ—¶é—´ã€ç¤¾ä¼šäº‹ä»¶æ•°æ®ï¼ŒåŠ¨æ€å‘ˆç°è¯—è¯åˆ›ä½œä¸æœä»£å˜è¿ã€æ–‡äººäº¤æ¸¸ã€æ–‡åŒ–æ½®æµçš„äº¤äº’å…³ç³»ã€‚
                        æœ€åèµ‹èƒ½è·¨å­¦ç§‘ç ”ç©¶ï¼šä¸ºæ–‡å­¦åœ°ç†å­¦ã€æƒ…æ„Ÿè®¡ç®—ã€æ–‡åŒ–ä¼ æ’­ç­‰äº¤å‰é¢†åŸŸæä¾›ç»“æ„åŒ–æ•°æ®æ”¯æŒï¼Œæ¨åŠ¨å®è¯å‹äººæ–‡ç ”ç©¶ã€‚
                    </p>
                </div>
            </div>
            <!-- æœç´¢åŒºåŸŸ -->
            <div class="search-box">
                <div class="search-item">
                    <input type="text" id="keyword" placeholder="è¾“å…¥è¯—è¯å…³é”®è¯">
                </div>
                <div class="search-item">
                    <input type="text" id="author" placeholder="è¾“å…¥ä½œè€…å§“å">
                </div>
                <div class="search-item">
                    <select name="dynasty" class="seldy" placeholder="é€‰æ‹©æœä»£">
                        <option value="" disabled selected>é€‰æ‹©æœä»£</option>
                        <option value="å”">å”æœ</option>
                        <option value="å®‹">å®‹æœ</option>
                    </select>
                </div>
                <div class="search-item">
                    <select name="style" class="seldy" placeholder="é€‰æ‹©ä½“è£">
                        <option value="" disabled selected>é€‰æ‹©ä½“è£</option>
                        <option value="ç»å¥">ç»å¥</option>
                        <option value="å¾‹è¯—">å¾‹è¯—</option>
                        <option value="æ’å¾‹">æ’å¾‹</option>
                        <option value="è¯—">è¯—</option>
                        <option value="è¯">è¯</option>
                    </select>
                </div>
                <div class="search-item">
                    <select name="focus" id="theme" class="seldy">
                        <option value="" disabled selected>é€‰æ‹©ä¸»é¢˜</option>
                        <option value="å’ç‰©">å’ç‰©</option>
                        <option value="æ€€å¤">æ€€å¤</option>
                        <option value="è¾¹å¡">è¾¹å¡</option>
                    </select>
                </div>
                <div class="search-item">
                    <input type="text" id="imagery" placeholder="è¾“å…¥æ„è±¡å…³é”®è¯">
                </div>
                <div class="search-item">
                    <button id="clearSearch" style="padding: 8px 16px; background-color: #f0f0f0; border: none; border-radius: 4px; cursor: pointer;">æ¸…é™¤æ¡ä»¶</button>
                </div>
            </div>

            <!-- ç»“æœè¡¨æ ¼ -->
            <table class="results-table">
                <thead>
                    <tr>
                        <th>è¯—å</th>
                        <th>ä½œè€…</th>
                        <th>æœä»£</th>
                        <th>ç±»åˆ«</th>
                        <th>ä¸»é¢˜</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            </table>
            <!-- æ–°å¢åˆ†é¡µæ§ä»¶ -->
            <div class="pagination">
                <button id="prevPage">ä¸Šä¸€é¡µ</button>
                <span id="pageInfo">ç¬¬1é¡µ / å…±1é¡µ</span>
                <button id="nextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>
    <!-- åœ¨bodyç»“æŸå‰æ·»åŠ æ¨¡æ€æ¡†ç»“æ„ -->
    <div id="poetryModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <p class="meta-info"><span id="modalAuthor"></span> | <span id="modalDynasty"></span></p>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3>ğŸ“œ åŸæ–‡</h3>
                    <pre id="modalContent"></pre>
                </div>
                <div class="columns">
                    <div class="col">
                        <h3>ğŸ›ï¸ åˆ›ä½œèƒŒæ™¯</h3>
                        <p id="modalBackground"></p>

                        <h3>ğŸ“Š é«˜é¢‘åˆ†æ</h3>
                        <ul id="modalFrequency"></ul>
                    </div>
                    <div class="col">
                        <h3>ğŸŒ å…³ç³»ç½‘ç»œ</h3>
                        <div id="modalNetwork" class="network-graph"></div>

                        <h3>ğŸ“– ä½œå“èµæ</h3>
                        <p id="modalDescription"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let filteredData = [];
        let poetryData = []; // å°†ä»APIè·å–
        
        // ä»APIåŠ è½½è¯—è¯æ•°æ®
        async function loadPoetryData() {
            try {
                // æ ¹æ®åç«¯APIå®é™…æƒ…å†µè°ƒæ•´è¯·æ±‚æ–¹å¼
                const response = await fetch('http://localhost:3000/api/poems?limit=2500');
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
                }
                const result = await response.json();
                console.log("APIè¿”å›çš„åŸå§‹æ•°æ®ç±»å‹:", typeof result, Array.isArray(result) ? "æ˜¯æ•°ç»„" : "ä¸æ˜¯æ•°ç»„");
                console.log("APIè¿”å›æ•°æ®åŒ…å«è®°å½•æ•°:", Array.isArray(result) ? result.length : (result.data ? result.data.length : "æœªçŸ¥"));
                
                // é€‚é…ä¸åŒçš„æ•°æ®è¿”å›æ ¼å¼
                if (result && typeof result === 'object' && result.success && Array.isArray(result.data)) {
                    // æ ‡å‡†APIå“åº”æ ¼å¼: {success: true, data: [...]}
                    poetryData = result.data;
                } else if (result && typeof result === 'object' && Array.isArray(result.data)) {
                    // å¦ä¸€ç§APIå“åº”æ ¼å¼: {data: [...]}
                    poetryData = result.data;
                } else if (Array.isArray(result)) {
                    // ç›´æ¥è¿”å›æ•°ç»„æ ¼å¼
                    poetryData = result;
                } else {
                    console.error("æ— æ³•è¯†åˆ«çš„APIè¿”å›æ ¼å¼:", result);
                    poetryData = [];
                }
                
                console.log("å¤„ç†åçš„è¯—è¯æ•°æ®:", poetryData.length, "é¦–è¯—è¯");
                
                if (poetryData.length === 0) {
                    console.warn("è­¦å‘Š: APIè¿”å›äº†0æ¡è¯—è¯æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜");
                    useExampleData(); // ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
                } else {
                    filteredData = poetryData;
                    renderTable();
                    
                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    if (result.pagination) {
                        const { total, pages } = result.pagination;
                        console.log(`æ•°æ®åº“å…±æœ‰${total}é¦–è¯—è¯ï¼Œåˆ†${pages}é¡µæ˜¾ç¤º`);
                    }
                }
            } catch (error) {
                console.error("åŠ è½½è¯—è¯æ•°æ®å¤±è´¥:", error.message);
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                document.getElementById('table-body').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <p>æ— æ³•ä»æœåŠ¡å™¨åŠ è½½æ•°æ®ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ã€‚</p>
                            <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                            <button id="retryBtn" style="padding: 5px 10px; margin-top: 10px;">é‡è¯•</button>
                        </td>
                    </tr>
                `;
                document.getElementById('retryBtn')?.addEventListener('click', loadPoetryData);
                
                // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
                useExampleData();
            }
        }
        
        // ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡
        function useExampleData() {
            console.log("ä½¿ç”¨ç¤ºä¾‹æ•°æ®ä½œä¸ºåå¤‡");
            poetryData = [
                {
                    id: 1,
                    title: 'é™å¤œæ€',
                    author: 'æç™½',
                    dynasty: 'å”',
                    genre: 'äº”è¨€ç»å¥',
                    theme: 'æ€ä¹¡',
                    imagery: 'æ˜æœˆ',
                    content: `åºŠå‰æ˜æœˆå…‰\nç–‘æ˜¯åœ°ä¸Šéœœ\nä¸¾å¤´æœ›æ˜æœˆ\nä½å¤´æ€æ•…ä¹¡`,
                    background: 'æ­¤è¯—åˆ›ä½œäºå¼€å…ƒåå››å¹´ï¼ˆ726å¹´ï¼‰ä¹æœˆåäº”æ—¥çš„æ‰¬å·æ—…èˆï¼Œæ—¶æç™½26å²ã€‚åœ¨ä¸€ä¸ªæœˆæ˜æ˜Ÿç¨€çš„å¤œæ™šï¼Œè¯—äººæŠ¬æœ›å¤©ç©ºä¸€è½®çš“æœˆï¼Œæ€ä¹¡ä¹‹æƒ…æ²¹ç„¶è€Œç”Ÿï¼Œå†™ä¸‹äº†è¿™é¦–ä¼ è¯µåƒå¤çš„åç¯‡ã€‚',
                    description: 'è¿™é¦–è¯—ä»¥æ¸…æ–°æœ´ç´ çš„ç¬”è§¦ï¼Œæç»˜äº†ç§‹æ—¥å¤œæ™šçš„æ™¯è‰²ã€‚è¯—äººç”¨æ˜ç™½å¦‚è¯çš„è¯­è¨€å°†æ€ä¹¡ä¹‹æƒ…è¡¨è¾¾å¾—æ·±åˆ»ç»†è…»ï¼Œä½“ç°äº†æç™½è¯—æ­Œè‡ªç„¶æ˜å¿«çš„é£æ ¼ã€‚',
                    network: {
                        contemporaries: ['æœç”«', 'ç‹ç»´'],
                        influenced: ['è‹è½¼', 'é™†æ¸¸']
                    },
                    frequency: {
                        keywords: ['æ˜æœˆ(3)', 'æ•…ä¹¡(2)'],
                        imagery: ['æœˆå…‰', 'éœœ', 'ä¸¾å¤´']
                    }
                },
                { id: 2, title: 'æ˜¥æœ›', author: 'æœç”«', dynasty: 'å”', genre: 'å¾‹è¯—', theme: 'å¿§å›½', imagery: 'è‰æœ¨' },
                { id: 3, title: 'æ°´è°ƒæ­Œå¤´', author: 'è‹è½¼', dynasty: 'å®‹', genre: 'è¯', theme: 'æ€€å¤', imagery: 'æ˜æœˆ' },
                { id: 4, title: 'è‰', author: 'è™ä¸–å—', dynasty: 'å”', genre: 'ç»å¥', theme: 'å¿§å›½', imagery: 'ç§‹é£' },
                { id: 5, title: 'æ›²æ± è·', author: ' å¢ç…§é‚»', dynasty: 'å”', genre: 'ç»å¥', theme: 'æŠ’æƒ…', imagery: 'ç§‹é£' },
                { id: 6, title: 'èµ‹å¾—å¦“', author: ' é™ˆå­è‰¯', dynasty: 'å”', genre: 'å¾‹è¯—', theme: 'æŠ’æƒ…', imagery: 'æ˜æœˆ' },
                { id: 7, title: 'å°†è¿›é…’', author: 'æç™½', dynasty: 'å”', genre: 'ä¹åºœè¯—', theme: 'æŠ’æƒ…', imagery: 'é»„æ²³' },
                { id: 8, title: 'ç™»é«˜', author: 'æœç”«', dynasty: 'å”', genre: 'å¾‹è¯—', theme: 'å¿§å›½', imagery: 'çŒ¿é¸Ÿ' },
                { id: 9, title: 'å±±å±…ç§‹æš', author: 'ç‹ç»´', dynasty: 'å”', genre: 'å¾‹è¯—', theme: 'æŠ’æƒ…', imagery: 'æ¸…æ³‰' },
                { id: 10, title: 'é”¦ç‘Ÿ', author: 'æå•†éš', dynasty: 'å”', genre: 'å¾‹è¯—', theme: 'æŠ’æƒ…', imagery: 'è´è¶' }
            ];
            filteredData = poetryData;
            renderTable();
        }
        
        // è·å–è¯—è¯è¯¦ç»†ä¿¡æ¯
        async function getPoetryDetails(id) {
            try {
                const response = await fetch(`http://localhost:3000/api/poems/${id}`);
                if (!response.ok) {
                    throw new Error('è·å–è¯—è¯è¯¦æƒ…å¤±è´¥');
                }
                return await response.json();
            } catch (error) {
                console.error("è·å–è¯—è¯è¯¦æƒ…å¤±è´¥:", error);
                // å¦‚æœæ— æ³•è·å–è¯¦æƒ…ï¼Œè¿”å›åŸºæœ¬æ•°æ®
                return filteredData.find(poem => poem.id === id) || {};
            }
        }

        // æ·»åŠ è¡¨æ ¼ç‚¹å‡»äº‹ä»¶
        document.getElementById('table-body').addEventListener('click', async function (e) {
            const row = e.target.closest('tr');
            if (!row) return;

            const index = Array.from(row.parentNode.children).indexOf(row);
            const poem = filteredData[(currentPage - 1) * pageSize + index];
            
            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            const modal = document.getElementById('poetryModal');
            modal.style.display = "block";
            document.getElementById('modalTitle').textContent = poem.title;
            document.getElementById('modalAuthor').textContent = poem.author;
            document.getElementById('modalDynasty').textContent = poem.dynasty;
            document.getElementById('modalContent').textContent = "åŠ è½½ä¸­...";
            
            // è·å–è¯¦ç»†ä¿¡æ¯
            try {
                const details = await getPoetryDetails(poem.id);
                showModal(details);
            } catch (error) {
                console.error("åŠ è½½è¯—è¯è¯¦æƒ…å¤±è´¥:", error);
                showModal(poem);
            }
        });

        // æ˜¾ç¤ºæ¨¡æ€æ¡†å‡½æ•°
        function showModal(data) {
            const modal = document.getElementById('poetryModal');
            modal.style.display = "block";

            // å¡«å……æ•°æ®
            document.getElementById('modalTitle').textContent = data.title || 'æœªçŸ¥æ ‡é¢˜';
            document.getElementById('modalAuthor').textContent = data.author || 'æœªçŸ¥ä½œè€…';
            document.getElementById('modalDynasty').textContent = data.dynasty || 'æœªçŸ¥æœä»£';
            document.getElementById('modalContent').textContent = data.content || 'æš‚æ— å†…å®¹';
            document.getElementById('modalBackground').textContent = data.background || 'æš‚æ— åˆ›ä½œèƒŒæ™¯ä¿¡æ¯';
            document.getElementById('modalDescription').textContent = data.description || 'æš‚æ— ä½œå“èµæ';

            // å¤„ç†é«˜é¢‘æ•°æ®
            const freqList = data.frequency && data.frequency.keywords ? 
                data.frequency.keywords.map(k => `<li>${k}</li>`).join('') : 
                '<li>æš‚æ— é«˜é¢‘è¯æ•°æ®</li>';
            document.getElementById('modalFrequency').innerHTML = freqList;

            // å¤„ç†å…³ç³»ç½‘ç»œ
            const network = data.network || { contemporaries: [], influenced: [] };
            document.getElementById('modalNetwork').innerHTML = `
                <div class="network-vis">
                    <p>åŒæœŸè¯—äººï¼š${network.contemporaries?.join(', ') || 'æš‚æ— æ•°æ®'}</p>
                    <p>å½±å“åä¸–ï¼š${network.influenced?.join(', ') || 'æš‚æ— æ•°æ®'}</p>
                </div>
            `;
        }

        // å…³é—­æ¨¡æ€æ¡†é€»è¾‘
        document.querySelector('.close').onclick = () => {
            document.getElementById('poetryModal').style.display = "none";
        }

        window.onclick = (e) => {
            if (e.target == document.getElementById('poetryModal')) {
                document.getElementById('poetryModal').style.display = "none";
            }
        }

        // æ¸²æŸ“è¡¨æ ¼å‡½æ•°
        function renderTable() {
            const tbody = document.getElementById('table-body');
            
            // ç¡®ä¿æœ‰æ•°æ®å¯æ˜¾ç¤º
            if (!filteredData || filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¯—è¯</td></tr>';
                document.getElementById('pageInfo').textContent = 'ç¬¬0é¡µ / å…±0é¡µ (å…±0é¦–è¯—è¯)';
                document.getElementById('prevPage').disabled = true;
                document.getElementById('nextPage').disabled = true;
                return;
            }
            
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);

            console.log(`å½“å‰é¡µ: ${currentPage}, æ˜¾ç¤ºæ•°æ®: ${start+1}-${end}, æ€»æ•°æ®: ${filteredData.length}`);

            tbody.innerHTML = pageData.map(item => `
                <tr>
                    <td>${item.title || ''}</td>
                    <td>${item.author || ''}</td>
                    <td>${item.dynasty || ''}</td>
                    <td>${item.category || item.genre || ''}</td>
                    <td>${item.theme || ''}</td>
                </tr>
            `).join('');

            updatePagination();
        }

        // æ›´æ–°åˆ†é¡µçŠ¶æ€
        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
            document.getElementById('pageInfo').textContent =
                `ç¬¬${currentPage}é¡µ / å…±${totalPages}é¡µ (å…±${filteredData.length}é¦–è¯—è¯)`;

            // æ˜ç¡®è®¾ç½®æŒ‰é’®çŠ¶æ€
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
            
            // æ›´æ”¹æ ·å¼ä½¿ç¦ç”¨çŠ¶æ€æ›´æ¸…æ™°
            if (prevButton.disabled) {
                prevButton.style.opacity = "0.5";
                prevButton.style.cursor = "not-allowed";
            } else {
                prevButton.style.opacity = "1";
                prevButton.style.cursor = "pointer";
            }
            
            if (nextButton.disabled) {
                nextButton.style.opacity = "0.5";
                nextButton.style.cursor = "not-allowed";
            } else {
                nextButton.style.opacity = "1";
                nextButton.style.cursor = "pointer";
            }
        }

        // åˆ†é¡µç‚¹å‡»äº‹ä»¶
        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                console.log("ç‚¹å‡»ä¸‹ä¸€é¡µï¼Œå½“å‰é¡µé¢ï¼š", currentPage);
            }
        });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                console.log("ç‚¹å‡»ä¸Šä¸€é¡µï¼Œå½“å‰é¡µé¢ï¼š", currentPage);
            }
        });

        // æœç´¢è¿‡æ»¤å‡½æ•°
        async function filterData() {
            // è·å–æ‰€æœ‰æœç´¢æ¡ä»¶
            const keyword = document.getElementById('keyword').value.trim();
            const author = document.getElementById('author').value.trim();
            const dynasty = document.querySelector('select[name="dynasty"]').value;
            const genre = document.querySelector('select[name="style"]').value;
            const theme = document.getElementById('theme').value;
            const imagery = document.getElementById('imagery').value.trim();
            
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams();
                if (keyword) params.append('keyword', keyword);
                if (author) params.append('author', author);
                if (dynasty && dynasty !== "") params.append('dynasty', dynasty);
                if (genre && genre !== "") params.append('genre', genre);
                if (theme && theme !== "") params.append('theme', theme);
                if (imagery) params.append('imagery', imagery);
                
                // ä»APIè·å–è¿‡æ»¤åçš„æ•°æ®
                const queryString = params.toString();
                const url = `http://localhost:3000/api/poems/search${queryString ? '?' + queryString : ''}`;
                console.log("å‘é€æœç´¢è¯·æ±‚:", url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('æœç´¢è¯·æ±‚å¤±è´¥');
                }
                
                const result = await response.json();
                console.log("æœç´¢ç»“æœ:", result);
                
                // å¤„ç†è¿”å›çš„æ•°æ®
                if (result.success && result.data) {
                    filteredData = result.data;
                    console.log("æœç´¢åˆ°", filteredData.length, "é¦–è¯—è¯");
                } else {
                    filteredData = Array.isArray(result) ? result : [];
                }
            } catch (error) {
                console.error("æœç´¢è¯·æ±‚å¤±è´¥:", error);
                // æœ¬åœ°è¿‡æ»¤ä½œä¸ºåå¤‡
                filteredData = poetryData.filter(item => {
                    const keywordMatch = !keyword || 
                        (item.title && item.title.includes(keyword)) ||
                        (item.author && item.author.includes(keyword)) ||
                        (item.content && item.content.includes(keyword));

                    const authorMatch = !author || 
                        (item.author && item.author.includes(author));
                    
                    const dynastyMatch = !dynasty || dynasty === "" || 
                        (item.dynasty && item.dynasty === dynasty);
                    
                    const genreMatch = !genre || genre === "" || 
                        (item.genre && item.genre.includes(genre));
                    
                    const themeMatch = !theme || theme === "" || 
                        (item.theme && item.theme === theme);
                    
                    const imageryMatch = !imagery || 
                        (item.imagery && item.imagery.includes(imagery));

                    return keywordMatch && authorMatch && dynastyMatch &&
                        genreMatch && themeMatch && imageryMatch;
                });
                console.log("æœ¬åœ°è¿‡æ»¤åæ‰¾åˆ°", filteredData.length, "é¦–è¯—è¯");
            }

            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            renderTable();
        }

        // å®æ—¶æœç´¢
        document.querySelectorAll('.search-item input, .search-item select').forEach(element => {
            element.addEventListener('input', filterData);
            element.addEventListener('change', filterData);
        });

        // é¡µé¢åŠ è½½æ—¶ï¼Œä»APIè·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', loadPoetryData);

        // æ¸…é™¤æœç´¢æ¡ä»¶
        document.getElementById('clearSearch').addEventListener('click', function() {
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
            document.getElementById('keyword').value = '';
            document.getElementById('author').value = '';
            document.getElementById('imagery').value = '';
            
            // é‡ç½®æ‰€æœ‰ä¸‹æ‹‰é€‰æ‹©æ¡†
            document.querySelector('select[name="dynasty"]').selectedIndex = 0;
            document.querySelector('select[name="style"]').selectedIndex = 0;
            document.getElementById('theme').selectedIndex = 0;
            
            // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
            filteredData = poetryData;
            currentPage = 1;
            renderTable();
        });
    </script>
</body>

</html>